<!DOCTYPE html>
<html lang="es" >
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
        <title>Chat</title>
        <link rel="stylesheet" type="text/css" href="http://code.jquery.com/mobile/latest/jquery.mobile.min.css">
        <link rel="stylesheet" type="text/css" href="estilo.css">
    </head>
    <body>
        <div id="login">
            <label>Ingresa tu nombre: </label>
            <input type="text" id="nuevonombre" size="33" maxlength="33" >
            <div>
                <a data-role="button" onclick="inicializar()" >Aceptar</a>
            </div>
        </div>

        <div id="container" style="display:none">
            <form>
                <div>
                    <label>Tu nombre: </label>
                    <input type="text" id="nombre" size="33" readonly >
                </div>
                <div id="mensajes" >Bienvenido...</div> 
                <div>
                    <input type="text" id="mimensaje" size="45" maxlength="45" placeholder="Ingresa un mensaje">
                </div>
                <div>
                    <a data-role="button" onclick="emitir()" >Enviar</a>
                </div>
            </form>
        </div>

        <script src="http://code.jquery.com/jquery.min.js" ></script>
        <script src="http://code.jquery.com/mobile/latest/jquery.mobile.min.js" ></script>
        <script src="config.js"></script>
        <script>            
            
            var socket;

            function inicializar(){
                $("#nombre").val( $("#nuevonombre").val() );
                $("#login").hide(1000);
                $("#container").show(1000);
                $("#mimensaje").focus();
                
                socket = io.connect('http://' + ipServidorChatNodeJs + ':' + portServidorChatNodeJs );
                socket.on('news', function (data) {
                    document.getElementById("mensajes").innerHTML = document.getElementById("mensajes").innerHTML + "<p>" + data + "</p>";
                    $("#mensajes").animate({scrollTop: $("#mensajes")[0].scrollHeight});
                });
                
                socket.emit('nuevomsj', "- " + $("#nombre").val() + " ha ingresado a la conversaci√≥n!"); 
                
                $("#mensajes").html("<p>Bienvenido " + $("#nombre").val() + "</p>");
            }
                    
            function emitir(){
                try{ 
                    if(!$("#nombre").val()) {
                        alert("Ingrese un nombre.");
                        return;
                    }        
                    if(!$("#mimensaje").val()) { 
                        return; 
                    }
                    var mimensaje = "<em>" + $("#nombre").val() + " dice</em>: " + $("#mimensaje").val();
                    $("#mimensaje").val("");
                    socket.emit('nuevomsj', mimensaje); 
                }catch(e){ 
                    alert(e);
                }
            }
            
            $(document).on("ready", function(){      
                $.mobile.changePage('#login', 'pop', false, true);

                $("#mimensaje").on("keypress", function(e){
                    if(e.keyCode == 13) {
                        emitir();
                    }
                });
                
                $("#nuevonombre").focus();
                
                $("#nuevonombre").on("keypress", function(e){
                    if(e.keyCode == 13 && $("#nuevonombre").val()) {
                        inicializar();
                    }
                });

            });

            (
                function(d){
                    var myscript = d.createElement('script');
                    myscript.src = 'http://' + ipServidorChatNodeJs + ':' + portServidorWebNodeJs + '/node_modules/socket.io-client/dist/socket.io.js';
                    myscript.type = 'text/javascript';
                    d.getElementsByTagName('head')[0].appendChild(myscript);
                }
            )(document);
        
        </script>            
    </body>
</html>